# 家庭用ストック管理アプリ 仕様書

## 1. アプリケーション概要
「家にあれあったっけ？」を解消するための、個体数ベースの在庫管理・購入履歴記録アプリです。

## 2. コアコンセプト
- **個体カウント**: 重さ（g）や量（ml）ではなく、本数や個数（ボトル、パック）を最小単位として管理します。
- **柔軟なメモ**: 同じ商品でもサイズが異なる場合は、商品マスタを分けずに購入時の「容量・メモ」で記録することで管理を簡略化します。
- **入力の簡素化**: 買い物は1件ずつサクッと登録し、単価入力のストレス（初期値0の削除、ポップアップ等）を排除しています。

## 3. 主要機能

### 3.1 在庫一覧（メイン画面）
- **統合ビュー**: 在庫一覧が唯一のメイン画面であり、ルート（`/`）からリダイレクトされます。在庫数0の商品も含めた全商品を表示します。
- **商品追加ボタン**: ヘッダーに「+ 商品追加」ボタンを配置。商品登録フォーム（`/products/new`）へ遷移します。商品追加時、在庫0のstockレコードが自動作成され、すぐに在庫一覧に表示されます。
- **編集モード（一括更新）**: 「編集モード」ボタンにより、リストをロックした状態で複数の商品の在庫数（+1/-1）やカテゴリをまとめて変更可能です。「保存して終了」をクリックすることで、変更内容が一括でサーバーへ送信されます。編集中の誤操作を防ぐため、編集モード中は並べ替え機能が制限されます。
- **タグ表示とリンク**: 各商品に付与されたタグがカラー別に表示されます。タグをクリックすることで、そのタグに関連する全商品を一覧表示する「タグ詳細ページ」へ遷移できます。
- **カテゴリ絞り込み**: 作成したカテゴリで表示商品を即座にフィルタリング可能です。
- **並び替え機能**: 在庫の「少ない順（デフォルト）」「多い順」でソート可能です。
- **商品詳細リンク**: 商品名をクリックすることで、その商品の詳細・購入履歴（価格履歴）へ遷移できます。

### 3.2 商品管理

#### 3.2.1 商品登録
- 「商品名」「カテゴリ」「タグ」を設定して登録。
- 登録と同時に在庫0のstockレコードが自動作成されます。

#### 3.2.2 商品詳細ページ (`/products/[id]`)
- **コンパクトなステータスヘッダー**: 商品名の下に、カテゴリ・在庫数・継続購入の3つの主要ステータスが、統一されたデザインのバッジ形式でコンパクトに横並びで配置されています。
- **商品名のインライン編集**: Pencilアイコンをクリックして商品名をその場で変更可能です。
- **カテゴリ変更**: バッジ内のドロップダウンからカテゴリを即座に変更可能です。
- **在庫数の直接編集**: 在庫数バッジ内のドロップダウン（Select）から、編集ボタンを経由せず直接在庫数を変更・保存可能です。
- **継続購入（アーカイブトグル）**: バッジ内のインライントグルスイッチ（ラベルは「継続購入」で固定）により、直感的に設定を切り替えられます。
- **商品URL**: ECサイトのリンクなどを保存でき、詳細画面から即座に商品ページへ遷移可能です。Pencilアイコンからインライン編集可能。
- **商品メモ**: 各商品ごとに、特徴や使い方などを自由に保存・編集できる常時表示のメモ欄があります。Pencilアイコンからインライン編集可能。
- **タグ管理**: 商品に付いているタグを表示し、「タグを編集」ダイアログから自由に追加・削除が可能です。
- **購入履歴（価格履歴）**:
    - 過去の購入記録を時系列で表示。
    - **容量メモの編集**: 過去の履歴の容量・メモ（サイズ等）を後から自由に変更可能です。
    - **履歴の削除**: 誤った購入記録を削除できます（在庫数は変更されません）。
- **クイック購入**: その商品を直近で買ったお店が自動選択された状態で、即座に購入登録できるフォームがあります。一度の操作で1つの商品の購入を記録し、登録完了と同時に在庫数が「購入個数」分だけ加算されます。
    - **入力項目**:
        - 購入日（デフォルトは今日）
        - お店（直近で利用したお店が自動選択）
        - 購入個数（何本、何パック買ったか）
        - **容量・メモ**: 「100ml」「詰め替え」など自由に記載。
        - 単価: 1つあたりの金額。
- **削除ダイアログ**: ゴミ箱アイコンをクリックすると、Dialogコンポーネントを使った確認ダイアログが表示されます。商品名と「関連する購入履歴・在庫データもすべて削除されます」という警告付き。削除後は在庫一覧（`/inventory`）へリダイレクトします。

#### 3.2.3 編集の排他制御
- 商品詳細ページ内の**商品名・URL・メモの3つのインラインエディタ**は、EditLockProvider（React Context）により排他制御されています。
- 1つのエディタで編集中は、他の2つのPencilアイコンが`disabled`になり、同時編集を防止します。

### 3.3 お店管理
- **店名登録**: 店名のみのシンプル管理です。
- **リネーム機能**: テーブル内でインライン編集が可能です。Pencilアイコンをクリックするとテキスト入力に切り替わり、Enter/✓で保存、Escape/✕でキャンセルできます。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更可能です。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供します。変更内容は一括で保存されます。
- **削除機能**: お店を削除しても、過去の購入履歴データ自体は維持されます（`store_id`がNULLに更新）。削除されたお店に紐づく履歴では、店名が「(不明)」と表示されます。
- **編集の排他制御**: 1つのお店名を編集中は、他のお店名のPencilアイコンおよびゴミ箱アイコンが`disabled`になります。

### 3.4 カテゴリ管理
- **カテゴリ作成**: 独自のカテゴリ（例: 非常食、おやつ）を自由に追加できます。
- **リネーム機能**: テーブル内でインライン編集が可能です。Pencilアイコンをクリックするとテキスト入力に切り替わり、Enter/✓で保存、Escape/✕でキャンセルできます。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更可能です。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供します。変更内容は一括で保存されます。
- **削除時の挙動**: カテゴリを削除しても、そのカテゴリだった商品は「未分類」として維持されます。
- **編集の排他制御**: 1つのカテゴリ名を編集中は、他のカテゴリ名のPencilアイコンおよびゴミ箱アイコンが`disabled`になります。

### 3.5 タグ管理
- **タグクラウドUI (/tags)**: 登録済みのタグがチップ状に並ぶ管理画面。
- **作成・編集機能**: その場で名前と10色のプリセットカラーを選んでタグを作成・編集・削除が可能です。編集(Settings2)アイコンは常時表示です。
- **削除時の挙動**: タグを削除すると、`product_tags`テーブルの`ON DELETE CASCADE`により、そのタグに関連する全商品からタグの関連付けが自動的に削除されます。商品自体には影響しません。
- **商品へのタグ付け**:
    - **新規登録時**: 商品追加フォームに検索可能なマルチセレクト機能があり、既存タグの選択や、未登録タグの即時作成が可能です。
    - **個別画面**: 商品詳細ページの上部に付与されているタグを表示し、「タグを編集」から自由に追加・削除が可能です。
- **タグ別ビュー (/tags/[id])**:
    - **対象商品リスト**: そのタグが付いている全商品を一覧表示。各商品カードには現在の在庫数がバッジで表示されます。継続購入OFFの商品はカード全体がグレーアウトされ、リスト末尾にまとめられます。
    - **統合購入履歴**: タグに関連する全商品の購入履歴を一つにまとめ、日付の新しい順に表示。行ごとに「どの商品の履歴か」が明記されます。継続購入OFFの商品の履歴行はグレーアウトされますが、表示順序は日付順のまま維持されます。

### 3.6 アーカイブ機能（もう買わない）
- **継続購入フラグ**: 各商品に「今後も継続して購入するか」を管理するフラグ（トグルスイッチ）を設置。詳細画面のヘッダーにあるコンパクトなトグル（ラベル：継続購入）から設定可能です。
- **リストへの反映**: 「もう買わない（トグルOFF）」に設定された商品は、**在庫一覧**および**タグ別ビュー**（対象商品リスト・統合購入履歴）においてリストの最下部にまとめられ、視覚的にグレーアウトされます。これにより、管理や確認が必要なアクティブな商品を優先して表示できます。
- **シンプルなUI**: 確認ダイアログなしで即座に設定を切り替えられ、トグルの色（ON：緑 / OFF：灰色）で状態が判別可能です。

### 3.7 ナビゲーション
- **サイドバー（デスクトップ）**: 「在庫一覧」をメインリンクとし、マスタ管理セクションに「タグ」「お店」「カテゴリ」を配置。商品一覧への個別リンクは廃止され、在庫一覧に統合されています。
- **モバイル下部ナビ**: 「在庫」「タグ」「お店」「カテゴリ」の4タブ構成です。

## 4. 技術スタック
- **Frontend**: Next.js 16.1.6 (App Router)
- **Styling**: Tailwind CSS v4, Shadcn/UI
- **Backend/Database**: Supabase (PostgreSQL)
- **Deployment**: Vercel

## 5. データ構造 (Supabase)
- `categories`: カテゴリ情報（`sort_order` を含む）
- `products`: 商品基本情報（`memo`, `category_id`, `is_archived`, `product_url` を含む）
- `tags`: タグ情報（`name`, `color_key` を含む）
- `product_tags`: 商品とタグの多対多中間テーブル（`ON DELETE CASCADE`設定）
- `stores`: 店舗情報（`sort_order` を含む）
- `purchases`: 購入イベントのヘッダー（`store_id`はNULL許容、お店削除時にNULLに更新）
- `purchase_lines`: 購入明細（`size_info` カラムに容量メモを保持）
- `stock`: 在庫スナップショット
- `stock_adjustments`: 手動調整履歴

## 6. UI/UXのこだわり

### 6.1 デザイン原則
- **高コントラストデザイン**: リストUI等の背景を不透明な白にし、枠線を強調（`border-slate-400`等）することで、視認性を向上させています。
- **ダイアログの統一スタイル**: すべてのダイアログは `bg-white border-2 border-slate-400 shadow-2xl` を使用し、ヘッダーとフッターの区切りは `border-t` のみ（二重線を防止）。`onOpenAutoFocus` でモバイルでのキーボード自動表示を抑制。

### 6.2 操作性
- **編集の排他制御**: 1つのフィールドが編集中のとき、同一画面内の他の編集ボタン・削除ボタンが`disabled`になり、同時操作を防止します。これはカテゴリ一覧、お店一覧、商品詳細ページのすべてに適用されています。
- **アイコンの常時表示**: 編集（Pencil）・設定（Settings2）のアイコンは常時表示です。ホバー時のみ表示する`opacity-0 group-hover:opacity-100`は使用しません（スマートフォンで操作できなくなるため）。
- **楽観的UI**: 在庫調整などの頻繁な操作において、即時のフィードバックを提供します。

### 6.3 モバイル最適化
- スマホで編集画面を開いた際にキーボードが勝手に立ち上がらないよう、ダイアログの自動フォーカス（autoFocus）を無効化しています。
- ドラッグ＆ドロップ操作（並べ替え）はタッチ操作に対応しています。

## 7. 運用ガイド
同じ「洗剤」でも、ボトル（1つ）と詰め替え（1つ）を在庫上は同じ「1」としてカウントする運用を推奨します。価格の比較は、詳細画面の履歴に表示される「容量メモ」を参照して判断します。
複数の商品にまたがる共通の属性（例: 「飲料」「要冷蔵」「ふるさと納税」など）はタグとして管理することで、カテゴリとは別の切り口で商品を整理・比較できます。

## 8. カスケード削除・参照整合性まとめ

| 操作 | 影響範囲 | 方式 |
| :--- | :--- | :--- |
| **商品を削除** | 購入履歴・在庫・タグ関連付けがすべて削除 | `ON DELETE CASCADE` |
| **カテゴリを削除** | 商品の`category_id`がNULLになる（未分類） | `ON DELETE SET NULL` |
| **お店を削除** | 購入の`store_id`がNULLになる（不明表示） | アプリ側でNULL更新後に削除 |
| **タグを削除** | `product_tags`の関連レコードが削除 | `ON DELETE CASCADE` |
