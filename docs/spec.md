# 家庭用ストック管理アプリ 仕様書

## 1. アプリケーション概要
「家にあれあったっけ？」を解消するための、個体数ベースの在庫管理・購入履歴記録アプリである。

## 2. コアコンセプト
- **個体カウント**: 重さ（g）や量（ml）ではなく、本数や個数（ボトル、パック）を最小単位として管理する。
- **柔軟なメモ**: 同じ商品でもサイズが異なる場合は、商品マスタを分けずに購入時の「容量・メモ」で記録することで管理を簡略化する。
- **入力の簡素化**: 買い物は1件ずつサクッと登録し、単価入力のストレス（初期値0の削除、ポップアップ等）を排除している。

## 3. 主要機能

### 3.1 在庫一覧（メイン画面）
- **統合ビュー**: 在庫一覧が唯一のメイン画面であり、ルート（`/`）からリダイレクトされる。在庫数0の商品も含めた全商品を表示する。
- **統一されたヘッダー**: 各画面の見出しは、アイコン + 2xlサイズの太字タイトルで統一されている。
- **表示順序の最適化**: リスト内では「在庫数」がカテゴリやタグよりも先に表示され、ひと目で残数を確認できるように配置されている。
- **編集モード（一括更新）**: フローティングアクションボタン（FAB）により、スクロール位置に関係なく即座に編集・保存が可能。リストをロックした状態で複数の商品の在庫数（+1/-1）、ステータス、カテゴリをまとめて変更できる。
    - **在庫管理モード切替**: 編集モード中、現在の「在庫数バッジ」をタップすることで、「数で管理（正確な数値）」と「多/少管理（ざっくり）」のモードを切り替えられる。
    - 多/少管理モード時は、数値の代わりに「多」および「少」ボタンが表示され、より手軽な在庫把握が可能（デフォルトは「少」）。
    - **編集中の商品名表示**: 編集モード中、右側に操作ボタンが並ぶため商品名スペースが狭くなる。長い商品名は1行で省略表示（末尾 …）され、カードサイズが変わらないよう制御されている。通常表示では折り返し表示される。
- **フローティングアクションボタン (FAB)**: 画面右下に常駐する縦並びの円形ボタン群。
    - **通常時**: 上段に「＋」ボタン（商品追加）、下段に Pencil ボタン（編集開始）。いずれもダークグレー（`bg-slate-900`）で統一されたデザイン。
    - **編集モード中**: 上段に Close ボタン（キャンセル）、下段に Check ボタン（保存）。商品追加ボタンは非表示。
    - **モバイル配慮**: 下部ナビゲーションとの重なりを防ぐため、スマホ環境では位置が自動的に上に調整される。
- **商品追加モーダル**: FAB の「＋」ボタンをタップすると、画面遷移せずに商品登録用のモーダルダイアログ（オーバーレイ）が開く。カテゴリフィルタで特定のカテゴリを選択中に「＋」ボタンを押した場合、登録画面のカテゴリ欄にそのカテゴリが自動的に初期選択される。登録完了後はダイアログが自動で閉じ、即座にリストに反映される。
- **在庫ステータス**: 各商品に3段階の在庫ステータスを設定可能。ステータスに応じてリストアイテムの背景色が変化し、ひと目で状況を把握できる。
    - **十分**（✓アイコン / 薄緑背景）: 在庫が十分にある状態。
    - **要購入**（カートアイコン / 薄赤背景）: 購入が必要・検討中の状態。
    - **未判断**（−アイコン / 通常背景）: まだ確認していない、または判断が必要な状態。
    - 編集モード中、+1/-1ボタンの右隣にあるステータスボタンをタップするたびに「未判断 → 十分 → 要購入 → …」と循環する。
    - **在庫変動時の自動リセット**: 編集モードで在庫数を増減させると、その商品のステータスは即座に「未判断」にリセットされる（DB保存は確定ボタン押下後）。
- **棚卸し機能（未更新商品の確認）**: フィルターパネル上部に「棚卸し」ボタン（未確認件数バッジ付き）が常駐する。
    - 設定された日数（デフォルト30日、設定画面から変更可能）以上、更新（`last_updated`）されていない商品が対象となる。
    - ボタンをタップすると専用のダイアログが開き、対象商品がリストカード形式で表示される。
    - ダイアログ内では、直接在庫数の変更（+1/-1、数/多・少の切り替え設定含む）と在庫ステータス（健全マーク）の変更が可能。
    - 商品ごとに✓ボタンをタップすると、入力内容を保存（内容に変更がない場合でも最終更新日時のみを現在時刻に更新）し、右へのスライドアウトアニメーションと共にリストから消去される。
    - ダイアログ展開時は背面の通常操作UI（FABなど）は誤操作防止のため非表示となる。
- **タグ表示とリンク**: 各商品に付与されたタグがカラー別に表示される。タグ名は表示崩れを防ぐため、一定の長さ（100px相当）で動的に省略表示（...）され、タグをクリックすることでそのタグに関連する全商品を一覧表示する「タグ詳細ページ」へ遷移できる。
- **フィルター・並び替えパネル**: リスト上部の常駐パネルで絞り込みと並び替えを操作する。編集モード中はパネル全体が半透明になり操作不可になるが、レイアウトの高さは変わらない。
    - **上段（カテゴリ・並べ替え）**: カテゴリ絞り込みと並び替えの2つのセレクトボックスが横並びで配置されている。
        - カテゴリ未設定の商品を絞り込む「未分類」も選択肢に含まれる。
        - 並び替えは「在庫が少ない順（デフォルト）」「在庫が多い順」「更新が古い順」「更新が新しい順」の4択。「更新が古い順」「更新が新しい順」を選択中は、各カードに最終更新日（`更新 M/D` 形式、前年以前は `YYYY/M/D`）が表示される。継続購入OFF（購入停止済み）商品はソートによる特別扱いなく、通常商品と同じ基準で並ぶ。
    - **下段（在庫ステータスフィルタ＋購入停止品チェック）**: ✓（十分）・🛒（要購入）・−（未判断）の3つのアイコンボタンと、右端に「購入停止品」チェックボックスが横並びで配置される。
        - ステータスボタンは複数選択可能なトグル式で、選択中はそのステータスのカラーで強調表示される。
        - 何も選択していない場合はすべて表示。選択している場合は該当ステータスの商品のみ表示される。
        - ステータスフィルタが有効なとき、継続購入OFF（購入停止済み）の商品は除外される。
        - **「購入停止品」チェックボックス**: デフォルト未チェック（非表示）。チェックすると継続購入OFFの商品が通常の並び順に混じって表示される。チェックをONにした状態でステータスフィルタを使用した場合は、購入停止済み商品は引き続き除外される。
- **スワイプによるカテゴリ切り替え**: モバイル操作時等に、リスト領域を左右にスワイプ（画面のフリック）することで前後のカテゴリへ素早く切り替えられる。最後のカテゴリで「次へ」進むと最初の「すべて」に戻り、最初のカテゴリから「前へ」戻ると最後のカテゴリに遷移するループ仕様となっている。誤操作を防ぐため、編集モード中はこのカテゴリ切り替えが行われないよう無効化される。
- **商品詳細リンク**: 商品名をクリックすることで、その商品の詳細・購入履歴（価格履歴）へ遷移できる（編集モード中は誤動作防止のため遷移しない）。

### 3.2 商品管理

#### 3.2.1 商品登録
- 画面右下の「＋」ボタンから開くモーダルダイアログにて、「商品名」「カテゴリ」「タグ」を設定して登録する。ダイアログ形式のため、入力前後のページロード待ちが発生しない。
- 在庫一覧でカテゴリフィルタを選択した状態で「＋」ボタンを押した場合、カテゴリが自動的に初期選択された状態でフォームが開く。
- 登録と同時に在庫0のstockレコードが自動作成される。

#### 3.2.2 商品詳細ページ (`/products/[id]`)
- **コンパクトなステータスヘッダー**: 商品名の下に、カテゴリ・在庫数・継続購入の3つの主要ステータスが、統一されたデザインのバッジ形式で横並びで配置されている。
    - 視認性向上のため、ラベル（12px）と値（14px）のフォントサイズを最適化し、バッジの高さ（h-9）を調整している。
- **商品名のインライン編集**: Pencilアイコンをクリックして商品名をその場で変更可能。
- **カテゴリ変更**: バッジ内のドロップダウンからカテゴリを即座に変更可能。
- **在庫数の直接編集**: 在庫数バッジ内のドロップダウン（Select）から、編集ボタンを経由せず直接在庫数を変更・保存が可能。数値だけでなく、多/少管理モード用の「多」「少」も選択できる。
- **継続購入（アーカイブトグル）**: バッジ内のインライントグルスイッチ（ラベルは「継続購入」で固定）により、直感的に設定を切り替えられる。
- **商品URL**: ECサイトのリンクなどを保存でき、詳細画面から即座に商品ページへ遷移できる。Pencilアイコンからインライン編集可能。
- **商品メモ**: 各商品ごとに、特徴や使い方などを自由に保存・編集できる常時表示のメモ欄がある。Pencilアイコンからインライン編集可能。
- **タグ管理**: 商品に付いているタグを表示し、「タグを編集」ダイアログから自由に追加・削除ができる。
- **購入履歴（価格履歴）**:
    - 過去の購入記録を時系列で表示。
    - **容量メモの編集**: 過去の履歴の容量・メモ（サイズ等）を後から自由に変更できる。
    - **履歴の削除**: 誤った購入記録を削除できる（在庫数は変更されない）。
- **クイック購入**: その商品を直近で買ったお店が自動選択された状態で、即座に購入登録できるフォームがある。一度の操作で1つの商品の購入を記録する履歴ログ機能である。
    - **在庫連動**: **購入記録と在庫数は連動しない**。在庫数は別途「在庫一覧」や詳細画面の「在庫数バッジ」から現状に合わせて更新する（履歴はあくまで価格の備忘録としての役割）。
    - **入力項目**:
        - 購入日（デフォルトは今日）
        - お店（直近で利用したお店が自動選択）
        - **単価**: 1つあたりの金額。
        - **メモ(容量等)**: 詰め替え容量や商品の特徴など。
- **削除ダイアログ**: ゴミ箱アイコンをクリックすると、Dialogコンポーネントを使った確認ダイアログが表示される。商品名と「関連する購入履歴・在庫データもすべて削除されます」という警告付き。削除後は在庫一覧（`/inventory`）へリダイレクトする。

#### 3.2.3 編集の排他制御
- 商品詳細ページ内の**商品名・URL・メモの3つのインラインエディタ**は、EditLockProvider（React Context）により排他制御されている。
- 1つのエディタで編集中は、他の2つのPencilアイコンが`disabled`になり、同時編集を防止する。

### 3.3 お店管理
- **店名登録**: 店名のみのシンプルな管理。
- **リネーム機能**: テーブル内でインライン編集が可能。Pencilアイコンをクリックするとテキスト入力に切り替わり、Enter/✓で保存、Escape/✕でキャンセルできる。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更できる。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供する。変更内容は一括で保存される。
- **削除機能**: お店を削除しても、過去の購入履歴データ自体は維持される（`store_id`がNULLに更新）。削除されたお店に紐づく履歴では、店名が「(不明)」と表示される。
- **編集の排他制御**: 1つのお店名を編集中は、他のお店名のPencilアイコンおよびゴミ箱アイコンが`disabled`になる。

### 3.4 カテゴリ管理
- **カテゴリ作成**: 独自のカテゴリ（例: 非常食、おやつ）を自由に追加できる。
- **リネーム機能**: テーブル内でインライン編集が可能。Pencilアイコンをクリックするとテキスト入力に切り替わり、Enter/✓で保存、Escape/✕でキャンセルできる。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更できる。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供する。変更内容は一括で保存される。
- **削除時の挙動**: カテゴリを削除しても、そのカテゴリだった商品は「未分類」として維持される。
- **編集の排他制御**: 1つのカテゴリ名を編集中は、他のカテゴリ名のPencilアイコンおよびゴミ箱アイコンが`disabled`になる。

### 3.5 タグ管理
- **タグクラウドUI (/tags)**: 登録済みのタグがチップ状に並ぶ管理画面。表示崩れ防止のため、各チップは最大 180px で省略表示される。
- **コントロールパネル**: 検索・色フィルタ・ソートを2行にまとめたコンパクトなパネル。
    - **1行目**: キーワード検索（`flex-1`）と並び替えセレクト（shadcn `Select` コンポーネント）が横並び。在庫一覧の並び替えと同一のUI部品・操作感で統一されている。
    - **2行目**: 色フィルタボタンが横スクロール可能な1行で並ぶ。色ボタンの並びはアプリ内の色定義順（スレート・レッド・オレンジ…）で固定され、登録タグが存在しない色は表示されない。
    - ソートは「色順（デフォルト）」「名前順」「新着順（作成日時）」の3択。色順が先頭でデフォルト値。
- **色グループ表示**: ソートが「色順」のとき、タグは色ごとのセクションに分けて表示される。各セクション先頭に色ドット＋色名を表示し、`divide-y` で視覚的に区切られる。それ以外のソートでは従来のフラットなフレックスラップ表示になる。
- **FAB（スピードダイアル）**: 画面右下の `+` ボタンをタップすると、2つのサブボタンが下から順にフェードインで展開する。
    - 🏷️ **タグを追加**: タグ作成ダイアログを開く。
    - ✏️ **一括編集**: 複数タグを選択して色を一括変更するバッチモードへ移行。
    - 展開中は `+` が `×` に変わり、もう一度タップで閉じる。
- **バッチモード**: 一括編集中はFABが「×（キャンセル）＋🎨（色を変更）」に切り替わる。タグを1件以上選択してから🎨をタップするとカラーピッカーダイアログが開き、選択したタグを一括で同じ色に変更できる。未選択の場合は🎨ボタンが無効化される。
- **詳細編集**: 個別タグの Settings2 アイコンから、名前とカラー（円形セレクター）を編集・削除できる。
- **削除時の挙動**: タグを削除すると、商品との関連付けが自動的に解除される（中間テーブルからの削除）。
- **タグ別ビュー (/tags/[id])**:
    - **対象商品リスト**: そのタグが付いている全商品を一覧表示。2カラムグリッドで並び、各商品カードには現在の在庫数がバッジで表示される。商品名は最大2行まで折り返し表示（`line-clamp-2`）され、長い名前や似た名前の商品でも識別しやすくなっている。継続購入OFFの商品はカード全体がグレーアウトされ、リスト末尾にまとめられる。
    - **ヘッダーの省略**: タイトルラベル（タグバッジ）が長すぎる場合は、コンテナ幅の 60% で省略表示される。
    - **統合購入履歴**: タグに関連する全商品の購入履歴を一つにまとめ、日付の新しい順に表示。行ごとに「どの商品の履歴か」が明記される。継続購入OFFの商品の履歴行はグレーアウトされるが、表示順序は日付順のまま維持される。

### 3.6 アーカイブ機能（もう買わない）
- **継続購入フラグ**: 各商品に「今後も継続して購入するか」を管理するフラグ（トグルスイッチ）を設置。詳細画面のヘッダーにあるコンパクトなトグル（ラベル：継続購入）から設定可能。
- **リストへの反映**:
    - **在庫一覧**: 「もう買わない（トグルOFF）」に設定された商品は、デフォルトで非表示になる。フィルターパネルの「購入停止品」チェックボックスをONにすると、通常商品と同じ並び順（在庫数・更新日順）に混じって表示され、視覚的にグレーアウトされる。
    - **タグ別ビュー**（対象商品リスト・統合購入履歴）: リストの最下部にまとめられ、視覚的にグレーアウトされる。
- **シンプルなUI**: 確認ダイアログなしで即座に設定を切り替えられ、トグルの色（ON：緑 / OFF：灰色）で状態が判別可能。

### 3.7 設定 (`/settings`)
- **管理機能の集約**: 「お店一覧」と「カテゴリ一覧」を一箇所にまとめ、各項目の説明とアイコンを添えた分かりやすいリスト形式で提供する。

### 3.8 ナビゲーション
- **サイドバー（デスクトップ）**: アイコン付きのクリーンなデザイン。常に「在庫一覧」「タグ一覧」「設定」の順で並び、現在の場所が強調表示される。
- **モバイル下部ナビ**: 「在庫」「タグ」「設定」の3タブ構成で、片手で主要機能にアクセス可能。
- **レスポンシブ**: デスクトップでもモバイルでも中央に寄せた `max-w-lg` のレイアウトを基本とし、一貫した操作感を実現している。

## 4. 技術スタック
- **Frontend**: Next.js 16.1.6 (App Router)
- **Styling**: Tailwind CSS v4, Shadcn/UI
- **Backend/Database**: Supabase (PostgreSQL)
- **Deployment**: Vercel

## 5. データ構造 (Supabase)
- `categories`: カテゴリ情報（`sort_order` を含む）
- `products`: 商品基本情報（`memo`, `category_id`, `is_archived`, `product_url` を含む）
- `tags`: タグ情報（`name`, `color_key` を含む）
- `product_tags`: 商品とタグの多対多中間テーブル（`ON DELETE CASCADE`設定）
- `stores`: 店舗情報（`sort_order` を含む）
- `purchases`: 購入イベントのヘッダー（`store_id`はNULL許容、お店削除時にNULLに更新）
- `purchase_lines`: 購入明細（`size_info` カラムに容量メモを保持）
- `stock`: 在庫スナップショット（`stock_status`カラムで在庫ステータスを管理: `sufficient` / `needed` / `unchecked`。`stock_mode`: `exact` / `approximate`による管理モード。`approximate_quantity`: `many` / `few` / `null`）
- `stock_adjustments`: 手動調整履歴

## 6. UI/UXのこだわり

### 6.1 デザイン原則
- **高コントラストデザイン**: リストUI等の背景を不透明な白にし、枠線を強調（`border-slate-400`等）することで、視認性を向上させている。
- **ダイアログの統一スタイル**: すべてのダイアログは `bg-white border-2 border-slate-400 shadow-2xl` を使用し、ヘッダーとフッターの区切りは `border-t` のみ（二重線を防止）。`onOpenAutoFocus` でモバイルでのキーボード自動表示を抑制。

### 6.2 操作性
- **編集の排他制御**: 1つのフィールドが編集中のとき、同一画面内の他の編集ボタン・削除ボタンが`disabled`になり、同時操作を防止する。これはカテゴリ一覧、お店一覧、商品詳細ページのすべてに適用されている。
- **アイコンの常時表示**: 編集（Pencil）・設定（Settings2）のアイコンは常時表示である。ホバー時のみ表示する`opacity-0 group-hover:opacity-100`は使用しない（スマートフォンで操作できなくなるため）。
- **楽観的UI**: 在庫調整などの頻繁な操作において、即時のフィードバックを提供する。

### 6.3 ページ遷移の即時化
- **loading.tsx**: 個別商品の詳細画面 (`/products/[id]`) 等にスケルトン付きの `loading.tsx` を配置している。Next.js App Router はこのファイルが存在するとデータ取得の完了を待たずに即座にスケルトンを表示するため、ページ遷移が体感的に瞬時になる。

### 6.4 モバイル最適化
- スマホで編集画面を開いた際にキーボードが勝手に立ち上がらないよう、ダイアログの自動フォーカス（autoFocus）を無効化している。
- ドラッグ＆ドロップ操作（並べ替え）はタッチ操作に対応している。
- **操作ボタンの安全圏**: フローティングボタンやモーダル要素が、OS/ブラウザのナビゲーションやアプリ固有のナビリンクと重ならないよう、パディングと Z-index を緻密に調整している。
- **スクロール領域の確保**: モバイルブラウザ特有のアドレスバー・ナビゲーションバーを考慮し、レイアウトの高さを `100dvh` で動的制御。さらにメインコンテンツの末尾に十分な余白（`pb-40`）を持たせることで、最下部のアイテムがFABや下部ナビに隠れることなくスクロール・タップ可能にしている。

## 7. 運用ガイド
同じ「洗剤」でも、ボトル（1つ）と詰め替え（1つ）を在庫上は同じ「1」としてカウントする運用を推奨する。価格の比較は、詳細画面の履歴に表示される「容量メモ」を参照して判断する。
複数の商品にまたがる共通の属性（例: 「飲料」「要冷蔵」「ふるさと納税」など）はタグとして管理することで、カテゴリとは別の切り口で商品を整理・比較できる。

## 8. カスケード削除・参照整合性まとめ

| 操作 | 影響範囲 | 方式 |
| :--- | :--- | :--- |
| **商品を削除** | 購入履歴・在庫・タグ関連付けがすべて削除 | `ON DELETE CASCADE` |
| **カテゴリを削除** | 商品の`category_id`がNULLになる（未分類） | `ON DELETE SET NULL` |
| **お店を削除** | 購入の`store_id`がNULLになる（不明表示） | アプリ側でNULL更新後に削除 |
| **タグを削除** | `product_tags`の関連レコードが削除 | `ON DELETE CASCADE` |
