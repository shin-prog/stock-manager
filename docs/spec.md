# 家庭用ストック管理アプリ 仕様書

## 1. アプリケーション概要
「家にあれあったっけ？」を解消するための、個体数ベースの在庫管理・購入履歴記録アプリです。

## 2. コアコンセプト
- **個体カウント**: 重さ（g）や量（ml）ではなく、本数や個数（ボトル、パック）を最小単位として管理します。
- **柔軟なメモ**: 同じ商品でもサイズが異なる場合は、商品マスタを分けずに購入時の「容量・メモ」で記録することで管理を簡略化します。
- **入力の簡素化**: 買い物は1件ずつサクッと登録し、単価入力のストレス（初期値0の削除、ポップアップ等）を排除しています。

## 3. 主要機能

### 3.1 在庫管理 (Dashboard)
- **一覧表示**: 登録されている全商品の現在の在庫数（個）を表示します。モバイル向けに最適化されたコンパクトなリスト表示を採用し、スクロール量を抑制しています。
- **クイック調整（楽観的UI）**: 「+1」「-1」ボタンにより、買い物を通さずとも手軽に在庫数を修正可能です。**楽観的UI（Optimistic UI）**を導入しており、ネットワークの遅延に関わらずボタンを押した瞬間に在庫表示が更新され、サクサクとした操作感を実現しています。
- **カテゴリ絞り込み**: 作成したカテゴリで表示商品を即座にフィルタリング可能です。
- **並び替え機能**: 「多い順」「少ない順」でリストをソート可能です。
- **商品詳細リンク**: 商品名をクリックすることで、その商品の購入履歴（価格履歴）へ遷移できます。

### 3.2 商品管理 (Master Data)
- **商品登録**: 「商品名」と「カテゴリ」のみのシンプル構成です。
- **カテゴリ絞り込み**: 商品一覧ページでもカテゴリによる絞り込みが可能です。
- **カテゴリインライン編集**: 商品一覧ページから、各商品のカテゴリをその場ですぐに変更可能です。
- **リネーム機能**: 商品詳細画面から、商品名をいつでも自由に変更可能です。
- **商品URL**: ECサイトのリンクなどを保存でき、詳細画面から即座に商品ページへ遷移可能です。
- **商品メモ**: 各商品ごとに、特徴や使い方などを自由に保存・編集できる常時表示のメモ欄があります。
- **商品詳細（価格履歴）**:
    - 過去の購入記録を時系列で表示。
    - **容量メモの編集**: 過去の履歴の容量・メモ（サイズ等）を後から自由に変更可能です。
    - **履歴の削除**: 誤った購入記録を削除できます（在庫数は変更されません）。
    - **クイック購入**: その商品を直近で買ったお店が自動選択された状態で、即座に購入登録できるフォームがあります。一度の操作で1つの商品の購入を記録し、登録完了と同時に在庫数が「購入個数」分だけ加算されます。
    - **入力項目**:
        - 購入日（デフォルトは今日）
        - お店（直近で利用したお店が自動選択）
        - 購入個数（何本、何パック買ったか）
        - **容量・メモ**: 「100ml」「詰め替え」など自由に記載。
        - 単価: 1つあたりの金額。
- **削除機能**: 不要になった商品をゴミ箱アイコンから削除可能です（確認ダイアログ付き）。

### 3.3 お店管理
- **店名登録**: 店名のみのシンプル管理です。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更可能です。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供します。変更内容は一括で保存されます。
- **削除機能**: お店を削除しても、過去の購入履歴データ自体は維持されます。ゴミ箱アイコンから実行可能です。

### 3.4 カテゴリ管理
- **カテゴリ作成**: 独自のカテゴリ（例: 非常食、おやつ）を自由に追加できます。
- **ドラッグ＆ドロップによる並び替え**: 「並び替え」モードにより、直感的なドラッグ＆ドロップ操作で表示順を変更可能です。スマートフォンなどのタッチ操作にも対応し、リスト外への飛び出し防止（移動範囲制限）機能により安定した操作感を提供します。変更内容は一括で保存されます。
- **削除時の挙動**: カテゴリを削除しても、そのカテゴリだった商品は「未分類」として維持されます。

### 3.5 タグ管理
- **タグクラウドUI (/tags)**: 登録済みのタグがチップ状に並ぶ管理画面。
- **作成・編集機能**: その場で名前と10色のプリセットカラーを選んでタグを作成・編集・削除が可能です。
- **商品へのタグ付け**:
    - **新規登録時**: 商品追加フォームに検索可能なマルチセレクト機能があり、既存タグの選択や、未登録タグの即時作成が可能です。
    - **個別画面**: 商品詳細ページの上部に付与されているタグを表示し、「タグを編集」から自由に追加・削除が可能です。
- **タグ別ビュー (/tags/[id])**:
    - **対象商品リスト**: そのタグが付いている全商品を一覧表示。
    - **統合価格履歴**: タグに関連する全商品の購入履歴を一つにまとめ、日付の新しい順に表示。行ごとに「どの商品の履歴か」が明記されます。

### 3.6 アーカイブ機能（もう買わない）
- **継続購入フラグ**: 各商品に「今後も継続して購入するか」を管理するフラグ（トグルスイッチ）を設置。
- **リストへの反映**: 「もう買わない」に設定された商品は、**在庫一覧**および**商品一覧**においてリストの最下部にまとめられ、視覚的にグレーアウトされます。これにより、管理や確認が必要なアクティブな商品を優先して表示できます。
- **シンプルなUI**: 詳細画面のトグルスイッチにより、確認ダイアログなしで即座に設定を切り替えられます。

### 3.7 ナビゲーション
- **アクセス性の向上**: サイドバーおよびモバイル用下部ナビゲーションに「タグ」メニューを常設し、どの画面からでも素早くタグ管理やタグ別表示にアクセス可能です。

## 4. 技術スタック
- **Frontend**: Next.js 16.1.6 (App Router)
- **Styling**: Tailwind CSS v4, Shadcn/UI
- **Backend/Database**: Supabase (PostgreSQL)
- **Deployment**: Vercel

## 5. データ構造 (Supabase)
- `categories`: カテゴリ情報（`sort_order` を含む）
- `products`: 商品基本情報（`memo`, `category_id`, `is_archived`, `product_url` を含む）
- `tags`: タグ情報（`name`, `color_key` を含む）
- `product_tags`: 商品とタグの多対多中間テーブル
- `stores`: 店舗情報（`sort_order` を含む）
- `purchases`: 購入イベントのヘッダー
- `purchase_lines`: 購入明細（`size_info` カラムに容量メモを保持）
- `stock`: 在庫スナップショット
- `stock_adjustments`: 手動調整履歴

## 6. UI/UXのこだわり
- **高コントラストデザイン**: リストUI等の背景を不透明な白にし、枠線を強調（`border-slate-400`等）することで、視認性を向上させています。
- **モバイル最適化**:
    - スマホで編集画面を開いた際にキーボードが勝手に立ち上がらないよう、自動フォーカス（autoFocus）を無効化しています。
    - ドラッグ＆ドロップ操作（並べ替え）はタッチ操作に対応しています。
- **楽観的UI**: 在庫調整などの頻繁な操作において、即時のフィードバックを提供します。

## 7. 運用ガイド
同じ「洗剤」でも、ボトル（1つ）と詰め替え（1つ）を在庫上は同じ「1」としてカウントする運用を推奨します。価格の比較は、詳細画面の履歴に表示される「容量メモ」を参照して判断します。
複数の商品にまたがる共通の属性（例: 「飲料」「要冷蔵」「ふるさと納税」など）はタグとして管理することで、カテゴリとは別の切り口で商品を整理・比較できます。
